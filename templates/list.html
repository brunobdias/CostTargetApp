{% extends "layout.html" %}

{% block content %}

<h3 class="mb-4">Cost Target List</h3>

{% if filters_active %}
<div style="background:#fff3cd; border:1px solid #ffecb5; padding:10px; border-radius:6px;"
     class="mb-3">

    <strong>Active filters:</strong>

    {% if prod_filter %}
        <span class="badge bg-primary">Prod: {{ prod_filter }}</span>
    {% endif %}

    {% if cat_filter %}
        <span class="badge bg-info">Cat: {{ cat_filter }}</span>
    {% endif %}
    
    {% if customer_filter %}
        <span class="badge bg-secondary">Cust: {{ customer_filter }}</span>
    {% endif %}

    {% if dept_filter not in ["", "all"] %}
        <span class="badge bg-success">Dept: {{ dept_filter }}</span>
    {% endif %}

    â€“ some results may be hidden.

    <a href="/clear_filters" class="btn btn-sm btn-outline-dark float-end">Clear</a>

</div>
{% endif %}


<!-- FILTERS -->
<form method="get" class="row g-3 mb-4">

    <div class="col-md-2">
        <label class="form-label fw-bold">Product</label>
        <input type="text"
               name="prodnum_filter"
               value="{{ prod_filter }}"
               class="form-control"
               placeholder="3001 or 3* or *01*">
    </div>

    <div class="col-md-2">
        <label class="form-label fw-bold">Category</label>
        <input type="text"
               name="buildcat_filter"
               value="{{ cat_filter }}"
               class="form-control"
               placeholder="3 or 3* or *3*">
    </div>

    <div class="col-md-2">
        <label class="form-label fw-bold">Customer</label>
        <input type="text"
            name="customer_filter"
            value="{{ customer_filter }}"
            class="form-control">
    </div>

    <div class="col-md-2">
        <label class="form-label fw-bold">Department</label>
        <select name="dept_filter" class="form-select">
            <option value="">All</option>
            {% for d in departments %}
                <option value="{{ d.department_id }}"
                    {% if dept_filter == d.department_id|string %}selected{% endif %}>
                    {{ d.department_id }} - {{ d.department_name }}
                    {% if not d.is_active %}(inactive){% endif %}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100">Filter</button>
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <a href="/clear_filters" class="btn btn-secondary w-100">Clear</a>
    </div>

</form>

<!-- ADD BUTTON -->
{% if session.get('role') in ['user', 'admin'] %}
    <div class="mb-3">
        <a href="{{ url_for('add_costtarget') }}" class="btn btn-success">
            + Add Cost Target
        </a>
    </div>
{% endif %}

<!-- TABLE -->
<div class="table-responsive">
<table class="table table-bordered table-striped align-middle">
    <thead class="table-dark">
        <tr>
            <th>
                <a href="?sort=prodnum&order={{ 'asc' if order=='desc' else 'desc' }}">Product</a>
            </th>

            <th>
                <a href="?sort=buildcatnum&order={{ 'asc' if order=='desc' else 'desc' }}">Category</a>
            </th>

            <th>
                <a href="?sort=target_cost&order={{ 'asc' if order=='desc' else 'desc' }}">Target Cost</a>
            </th>

            <th>
                <a href="?sort=customer&order={{ 'asc' if order=='desc' else 'desc' }}">Customer</a>
            </th>

            <th>Comments</th>

            <th>
                <a href="?sort=department&order={{ 'asc' if order=='desc' else 'desc' }}">Department</a>
            </th>

            <th>
                <a href="?sort=created_at&order={{ 'asc' if order=='desc' else 'desc' }}">Created At</a>
            </th>

            <th>Created By</th>

            <th>
                <a href="?sort=updated_at&order={{ 'asc' if order=='desc' else 'desc' }}">Updated At</a>
            </th>

            <th>Updated By</th>

            {% if session.get('role') in ['user', 'admin'] %}
                <th>Actions</th>
            {% endif %}
        </tr>
    </thead>

    <tbody>
        {% for r in rows %}
        <tr>
            <td>{{ r.prodnum }}</td>
            <td>{{ r.buildcatnum }}</td>
            <td>{{ r.target_cost }}</td>
            <td>{{ r.customer }}</td>
            <td>{{ r.comments }}</td>
            <td>{{ r.department_name }}</td>

            <td>{{ r.created_at | fmt}}</td>
            <td>{{ r.created_by }}</td>

            <td>{{ r.updated_at | fmt}}</td>
            <td>{{ r.updated_by }}</td>
            {% if session.get('role') in ['user', 'admin'] %}
                <td>
                    <a href="{{ url_for('edit_costtarget_page', record_id=r.id) }}"
                    class="btn btn-primary btn-sm">
                        Edit
                    </a>
                </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>

</table>
</div>

{% endblock %}
